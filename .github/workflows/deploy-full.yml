name: Full Deploy to PythonAnywhere

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # ÊâãÂãïÂÆüË°å„ÇÇÂèØËÉΩ

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy and Reload PythonAnywhere
        env:
          PA_API_TOKEN: ${{ secrets.PYTHONANYWHERE_API_TOKEN }}
          PA_USERNAME: nnnkeita
          PA_DOMAIN: nnnkeita.pythonanywhere.com
        run: |
          echo "üöÄ Deploying to PythonAnywhere..."
          
          # Check if API token is set
          if [ -z "$PA_API_TOKEN" ]; then
            echo "‚ùå PYTHONANYWHERE_API_TOKEN is not configured"
            echo "   Please add the secret to GitHub repository settings"
            exit 1
          fi
          
          # Get list of webapps first to verify authentication
          echo "üìã Verifying PythonAnywhere API access..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Token $PA_API_TOKEN" \
            https://www.pythonanywhere.com/api/v0/user/$PA_USERNAME/webapps/)
          
          if [ "$STATUS" != "200" ]; then
            echo "‚ùå Failed to access PythonAnywhere API (HTTP $STATUS)"
            echo "   Check PYTHONANYWHERE_API_TOKEN"
            exit 1
          fi
          
          echo "‚úÖ API authentication successful"
          
          # Reload the webapp
          echo "üîÑ Reloading PythonAnywhere web app..."
          RELOAD_URL="https://www.pythonanywhere.com/api/v0/user/$PA_USERNAME/webapps/$PA_DOMAIN/reload/"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Token $PA_API_TOKEN" \
            "https://www.pythonanywhere.com/api/v0/user/$PA_USERNAME/webapps/$PA_DOMAIN/reload/")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "204" ]; then
            echo "‚úÖ PythonAnywhere reload successful (HTTP $HTTP_CODE)"
            echo "   Response: $BODY"
          else
            echo "‚ö†Ô∏è Reload returned HTTP $HTTP_CODE"
            echo "   Response: $BODY"
            # Don't exit on error - reload might still work
          fi
          
          echo "üìù Deployment info:"
          echo "   Repository: $GITHUB_REPOSITORY"
          echo "   Commit: $GITHUB_SHA"
          echo "   Branch: $GITHUB_REF"
          echo "   Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
